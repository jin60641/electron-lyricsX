import { katakanaRegex } from '../regex';

const KANA_DICT: Record<string, string> = {
  "あ": "아", "い": "이", "う": "우", "え": "에", "お": "오",
  "か": "카", "き": "키", "く": "쿠", "け": "케", "こ": "코",
  "さ": "사", "し": "시", "す": "스", "せ": "세", "そ": "소",
  "た": "타", "ち": "치", "つ": "츠", "て": "테", "と": "토",
  "な": "나", "に": "니", "ぬ": "누", "ね": "네", "の": "노",
  "は": "하", "ひ": "히", "ふ": "후", "へ": "헤", "ほ": "호",
  "ま": "마", "み": "미", "む": "무", "め": "메", "も": "모",
  "や": "야", "ゆ": "유", "よ": "요",
  "ら": "라", "り": "리", "る": "루", "れ": "레", "ろ": "로",
  "わ": "와", "を": "오",
  "が": "가", "ぎ": "기", "ぐ": "구", "げ": "게", "ご": "고",
  "ざ": "자", "じ": "지", "ず": "즈", "ぜ": "제", "ぞ": "조",
  "だ": "다", "ぢ": "지", "づ": "즈", "で": "데", "ど": "도",
  "ば": "바", "び": "비", "ぶ": "부", "べ": "베", "ぼ": "보",
  "ぱ": "파", "ぴ": "피", "ぷ": "푸", "ぺ": "페", "ぽ": "포",
  "ア": "아", "イ": "이", "ウ": "우", "エ": "에", "オ": "오",
  "カ": "카", "キ": "키", "ク": "쿠", "ケ": "케", "コ": "코",
  "サ": "사", "シ": "시", "ス": "스", "セ": "세", "ソ": "소",
  "タ": "타", "チ": "치", "ツ": "츠", "テ": "테", "ト": "토",
  "ナ": "나", "ニ": "니", "ヌ": "누", "ネ": "네", "ノ": "노",
  "ハ": "하", "ヒ": "히", "フ": "후", "ヘ": "헤", "ホ": "호",
  "マ": "마", "ミ": "미", "ム": "무", "メ": "메", "モ": "모",
  "ヤ": "야", "ユ": "유", "ヨ": "요",
  "ラ": "라", "リ": "리", "ル": "루", "レ": "레", "ロ": "로",
  "ワ": "와", "ヲ": "오",
  "ガ": "가", "ギ": "기", "グ": "구", "ゲ": "게", "ゴ": "고",
  "ザ": "자", "ジ": "지", "ズ": "즈", "ゼ": "제", "ゾ": "조",
  "ダ": "다", "ヂ": "지", "ヅ": "즈", "デ": "데", "ド": "도",
  "バ": "바", "ビ": "비", "ブ": "부", "ベ": "베", "ボ": "보",
  "パ": "파", "ピ": "피", "プ": "푸", "ペ": "페", "ポ": "포",
  "ぁ": "아", "ぃ": "이", "ぅ": "우", "ぇ": "에", "ぉ": "오",
  "ゃ": "야", "ゅ": "유", "ょ": "요", "ゎ": "와",
  "ァ": "아", "ィ": "이", "ゥ": "우", "ェ": "에", "ォ": "오",
  "ャ": "야", "ュ": "유", "ョ": "요", "ヮ": "와",
};

const EXTENDED_KANA_DICT: Record<string, string> = {
  "きゃ": "캬", "きゅ": "큐", "きょ": "쿄",
  "しゃ": "샤", "しゅ": "슈", "しょ": "쇼",
  "ちゃ": "챠", "ちゅ": "츄", "ちょ": "쵸",
  "にゃ": "냐", "にゅ": "뉴", "にょ": "뇨",
  "ひゃ": "햐", "ひゅ": "휴", "ひょ": "효",
  "みゃ": "먀", "みゅ": "뮤", "みょ": "묘",
  "りゃ": "랴", "りゅ": "류", "りょ": "료",
  "ぎゃ": "갸", "ぎゅ": "규", "ぎょ": "교",
  "じゃ": "자", "じゅ": "주", "じょ": "조",
  "ぢゃ": "자", "ぢゅ": "주", "ぢょ": "조",
  "びゃ": "뱌", "びゅ": "뷰", "びょ": "뵤",
  "ぴゃ": "퍄", "ぴゅ": "퓨", "ぴょ": "표",
  "キャ": "캬", "キュ": "큐", "キョ": "쿄",
  "シャ": "샤", "シュ": "슈", "ショ": "쇼",
  "チャ": "챠", "チュ": "츄", "チョ": "쵸",
  "ニャ": "냐", "ニュ": "뉴", "ニョ": "뇨",
  "ヒャ": "햐", "ヒュ": "휴", "ヒョ": "효",
  "ミゃ": "먀", "ミュ": "뮤", "ミョ": "묘",
  "リャ": "랴", "リュ": "류", "リョ": "료",
  "ギャ": "갸", "ギュ": "규", "ギョ": "교",
  "ジャ": "자", "ジュ": "주", "ジョ": "조",
  "ヂャ": "자", "ヂュ": "주", "ヂョ": "조",
  "ビャ": "뱌", "ビュ": "뷰", "ビョ": "뵤",
  "ピャ": "퍄", "ピュ": "퓨", "ピョ": "표",
  "イェ": "예", "ウィ": "위", "ウェ": "웨", "ウォ": "워",
  "ヴァ": "바", "ヴィ": "비", "ヴ": "부", "ヴェ": "베", "ヴォ": "보",
  "ヴュ": "뷰", "クァ": "콰", "クィ": "퀴", "クェ": "퀘", "クォ": "쿼",
  "グァ": "과", "シェ": "셰", "ジェ": "제", "チェ": "체",
  "ツァ": "차", "ツィ": "치", "ツェ": "체", "ツォ": "초",
  "ティ": "티", "トゥ": "투", "テュ": "튜", "ディ": "디", "ドゥ": "두", "デュ": "듀",
  "ファ": "파", "フィ": "피", "フェ": "페", "フォ": "포", "フュ": "퓨",
};

export class HangulHelper {
  static addJongseong(char: string, jongIndex: number): string {
    const code = char.charCodeAt(0);
    if (code < 0xAC00 || code > 0xD7A3) return char;
    const base = code - 0xAC00;
    const choseong = Math.floor(base / (21 * 28));
    const jungseong = Math.floor((base / 28) % 21);
    return String.fromCharCode(0xAC00 + (choseong * 21 * 28) + (jungseong * 28) + jongIndex);
  }

  static kanaToHangul(text: string, useHyphen = false): string {
    const result: string[] = [];
    let i = 0;
    const target = text;

    while (i < target.length) {
      const twoChar = target.substr(i, 2);
      if (EXTENDED_KANA_DICT[twoChar]) {
        result.push(EXTENDED_KANA_DICT[twoChar]);
        i += 2;
        continue;
      }
      const oneChar = target[i];
      if (KANA_DICT[oneChar]) result.push(KANA_DICT[oneChar]);
      else if (oneChar === 'ー') result.push(useHyphen ? '-' : '');
      else result.push(oneChar);
      i++;
    }
    // 촉음(っ) 및 ん 처리 로직 (Python kana_to_hangul 반영)
    for (let j = 0; j < result.length; j++) {
      if (result[j] === 'っ' || result[j] === 'ん') {
        if (j > 0) {
          const prev = result[j - 1];
          const jongIdx = result[j] === 'っ' ? 19 : 4;
          const combined = this.addJongseong(prev, jongIdx);
          if (combined !== prev) {
            result[j - 1] = combined;
            result.splice(j, 1);
            j--;
          }
        }
      }
    }
    return result.join('');
  }

  static toHiragana(text: string): string {
    return text.replace(katakanaRegex, (s) => String.fromCharCode(s.charCodeAt(0) - 0x60));
  }
}
